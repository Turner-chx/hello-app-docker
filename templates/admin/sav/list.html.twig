{% extends 'bundles/EasyAdminExtensionBundle/default/list.html.twig' %}

{% set _entity_config = easyadmin_entity(app.request.query.get('entity')) %}
{% trans_default_domain _entity_config.translation_domain %}
{% set _trans_parameters = { '%entity_name%': _entity_config.name|trans, '%entity_label%': _entity_config.label|trans } %}

{% set _fields_visible_by_user = fields|filter((metadata, field) => easyadmin_is_granted(metadata.permission)) %}
{% set _number_of_hidden_results = 0 %}
{% set _list_item_actions = easyadmin_get_actions_for_list_item(_entity_config.name) %}

{% set actions = _entity_config.actions %}
{% set _action = easyadmin_get_action_for_list_view('new', _entity_config.name) %}

{% block new_action %}

    {% for action in actions %}
        {% if is_granted(action.role) %}
            <div class="button-action">
                <a class="{{ action.css_class|default('btn btn-primary action-new') }}" href="{{ path(action.name, _request_parameters|merge({ action: _action.name })) }}">
                    {{ action.label is defined and not _action.label is empty ? action.label|trans(_trans_parameters) }}
                </a>
            </div>
        {% endif %}
    {% endfor %}
    <div class="button-action">
        <a class="{{ _action.css_class|default('') }}"
           href="{{ path('easyadmin', _request_parameters|merge({ action: _action.name })) }}"
           target="{{ _action.target }}">
            {% if _action.icon %}<i class="fa fa-fw fa-{{ _action.icon }}"></i>{% endif %}
            {{ _action.label is defined and not _action.label is empty ? _action.label|trans(_trans_parameters) }}
        </a>
    </div>
{% endblock new_action %}

{% block table_body %}
    {% for item in paginator.currentPageResults %}
        {% if not easyadmin_is_granted(_entity_config.list.item_permission, item) %}
            {% set _number_of_hidden_results = _number_of_hidden_results + 1 %}
        {% else %}
            {# the empty string concatenation is needed when the primary key is an object (e.g. an Uuid object) #}
            {% set _item_id = '' ~ attribute(item, _entity_config.primary_key_field_name) %}

            <tr data-id="{{ _item_id }}">
                {% if _has_batch_actions %}
                    <td><input type="checkbox" class="form-batch-checkbox" value="{{ _item_id }}"></td>
                {% endif %}

                {% for field, metadata in _fields_visible_by_user %}
                    {% set isSortingField = metadata.property == app.request.get('sortField') %}
                    {% set _column_label =  (metadata.label ?: field|humanize)|trans(_trans_parameters)  %}

                    {% set isNew = item.isNew %}
                    {% set newMessage = item.newMessage %}
                    {% set source = item.source %}
                    {% set statusSetting = item.statusSetting %}
                    {% set repairDate = item.repairDate %}

                    <td class="{{ isSortingField ? 'sorted' }} {{ metadata.dataType|lower }} {{ metadata.css_class }}
                        {% if field == 'id' %}
                            {% if isNew and newMessage%}
                                box-triangle
                            {% elseif isNew%}
                                box-triangle-new
                            {% elseif newMessage %}
                                box-triangle-message
                            {% endif %}
                        {% endif %}"
                        {% if field == 'source.name' and source.color is defined %}
                            style="background-color: {{ source.color }}"
                        {% endif %}
                        {% if field == 'statusSetting.setting' %}
                            style="font-weight: bold;
                            {% if statusSetting.color is defined %}
                                color: {{ statusSetting.color }}
                            {% endif %}
                                "
                        {% endif %}
                    {{ easyadmin_config('design.rtl') ? 'dir="rtl"' }}>

                        {% if field == 'statusSetting.setting' and repairDate is not null%}
                            {{ easyadmin_render_field_for_list_view(_entity_config.name, item, metadata) }} <br>
                            {{ 'app.entity.Sav.message.before'|trans }} {{ repairDate|date('d/m/Y') }}
                        {% else %}
                            {{ easyadmin_render_field_for_list_view(_entity_config.name, item, metadata) }}
                        {% endif %}
                    </td>
                {% endfor %}

                {% if _list_item_actions|length > 0 %}
                    {% set _column_label =  'list.row_actions'|trans(_trans_parameters, 'EasyAdminBundle') %}
                    <td class="actions">
                        {% block item_actions %}
                            {% set _actions_template = _entity_config.list.collapse_actions
                                ? '@EasyAdmin/default/includes/_actions_dropdown.html.twig'
                                : '@EasyAdmin/default/includes/_actions.html.twig'
                            %}
                            {{ include(_actions_template, {
                                actions: _list_item_actions,
                                entity_config: _entity_config,
                                request_parameters: _request_parameters,
                                translation_domain: _entity_config.translation_domain,
                                trans_parameters: _trans_parameters,
                                item_id: _item_id,
                                item: item
                            }, with_context = false) }}
                        {% endblock item_actions %}
                    </td>
                {% endif %}
            </tr>
        {% endif %}
    {% else %}
        <tr>
            <td class="no-results" colspan="{{ _fields_visible_by_user|length + 1 }}">
                {{ 'search.no_results'|trans(_trans_parameters, 'EasyAdminBundle') }}
            </td>
        </tr>
    {% endfor %}

    {% if _number_of_hidden_results > 0 %}
        <tr class="datagrid-row-empty">
            <td class="text-center" colspan="{{ _fields_visible_by_user|length + 1 }}">
                <span class="datagrid-row-empty-message"><i class="fa fa-lock mr-1"></i> {{ 'security.list.hidden_results'|trans({}, 'EasyAdminBundle') }}</span>
            </td>
        </tr>
    {% endif %}
{% endblock table_body %}
